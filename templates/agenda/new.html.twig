{% extends 'base.html.twig' %}

{% block title %}Agenda | Nouveau{% endblock %}
{% block javascripts %}
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.7.3/themes/base/jquery-ui.css">
{% endblock %}
{% block body %}
    <main id="main">
        <!-- ======= Breadcrumbs ======= -->
        <section id="breadcrumbs" class="breadcrumbs">
            <div class="container">
                <ol>
                    <li><a href="{{ path('app_home') }}">Home</a></li>
                    <li><a href="{{ path('app_profile') }}">Dashboard</a></li>
                    <li><a href="{{ path('agenda_index') }}">Evénements</a></li>
                    <li>Création</li>
                </ol>
                <h2>Nouvel évenement</h2>
            </div>
        </section><!-- End Breadcrumbs -->
        <section class="inner-page">
            <div class="container">
                <div class="col-md-12">

                {{ include('agenda/_form.html.twig') }}
                </div>

            </div>
        </section>
    </main>
    <script>
        $("#agenda_code_postal").autocomplete({
            source: function (request, response) {
                $.ajax({
                    url: "https://api-adresse.data.gouv.fr/search/?postcode="+$("input[name='agenda[code_postal]']").val(),
                    data: { q: request.term },
                    dataType: "json",
                    success: function (data) {
                        var postcodes = [];
                        response($.map(data.features, function (item) {

                            if ($.inArray(item.properties.postcode, postcodes) == -1) {
                                postcodes.push(item.properties.postcode);
                                return { label: item.properties.postcode + " - " + item.properties.city,
                                    city: item.properties.city,
                                    context: item.properties.context,
                                    value: item.properties.postcode
                                };
                            }
                        }));
                    }
                });
            },
            // On remplit aussi la ville
            select: function(event, ui) {
                $('#agenda_city').val(ui.item.city);
                $('#agenda_departement').val(ui.item.context);
            }
        });
        $("#agenda_city").autocomplete({
            source: function (request, response) {
                $.ajax({
                    url: "https://api-adresse.data.gouv.fr/search/?city="+$("input[name='agenda[city]']").val(),
                    data: { q: request.term },
                    dataType: "json",
                    success: function (data) {
                        var cities = [];
                        response($.map(data.features, function (item) {
                            // Ici on est obligé d'ajouter les villes dans un array pour ne pas avoir plusieurs fois la même
                            if ($.inArray(item.properties.postcode, cities) == -1) {
                                cities.push(item.properties.postcode);
                                return { label: item.properties.postcode + " - " + item.properties.city,
                                    postcode: item.properties.postcode,
                                    context: item.properties.context,
                                    value: item.properties.city
                                };
                            }
                        }));
                    }
                });
            },
            // On remplit aussi le CP
            select: function(event, ui) {
                $('#agenda_code_postal').val(ui.item.postcode);
                $('#agenda_departement').val(ui.item.context);
            }
        });
        $("#agenda_address").autocomplete({
            source: function (request, response) {
                $.ajax({
                    url: "https://api-adresse.data.gouv.fr/search/?postcode="+$("input[name='agenda[code_postal]']").val(),
                    data: { q: request.term },
                    dataType: "json",
                    success: function (data) {
                        response($.map(data.features, function (item) {
                            return { label: item.properties.name, value: item.properties.name};
                        }));
                    }
                });
            }
        });
    </script>
{% endblock %}



