<script>
    let zipcode = $('#agenda_code_postal');
    let city = $('#agenda_city');
    let departement = $('#agenda_departement');
    let adresse = $('#agenda_address');
    let zipcodeName = $('agenda[code_postal]');
    let cityName = $('agenda[city]');

    $(zipcode).autocomplete({
        source: function (request, response) {
            $.ajax({
                url: "https://api-adresse.data.gouv.fr/search/?postcode="+$("input[name=zipcodeName]").val(),
                data: { q: request.term },
                dataType: "json",
                success: function (data) {
                    var postcodes = [];
                    response($.map(data.features, function (item) {

                        if ($.inArray(item.properties.postcode, postcodes) == -1) {
                            postcodes.push(item.properties.postcode);
                            return { label: item.properties.postcode + " - " + item.properties.city,
                                city: item.properties.city,
                                context: item.properties.context,
                                value: item.properties.postcode
                            };
                        }
                    }));
                }
            });
        },
        // On remplit aussi la ville et le département
        select: function(event, ui) {
            $(city).val(ui.item.city);
            $(departement).val(ui.item.context);
        }
    });
    $(city).autocomplete({
        source: function (request, response) {
            $.ajax({
                url: "https://api-adresse.data.gouv.fr/search/?city="+$("input[name=cityName]").val(),
                data: { q: request.term },
                dataType: "json",
                success: function (data) {
                    var cities = [];
                    response($.map(data.features, function (item) {
                        // Ici on est obligé d'ajouter les villes dans un array pour ne pas avoir plusieurs fois la même
                        if ($.inArray(item.properties.postcode, cities) == -1) {
                            cities.push(item.properties.postcode);
                            return { label: item.properties.postcode + " - " + item.properties.city,
                                postcode: item.properties.postcode,
                                context: item.properties.context,
                                value: item.properties.city
                            };
                        }
                    }));
                }
            });
        },
        // On remplit aussi le CP et le département
        select: function(event, ui) {
            $(zipcode).val(ui.item.postcode);
            $(departement).val(ui.item.context);
        }
    });

    $(adresse).autocomplete({
        source: function (request, response) {
            $.ajax({
                url: "https://api-adresse.data.gouv.fr/search/?postcode="+$("input[name='agenda[code_postal]']").val(),
                data: { q: request.term },
                dataType: "json",
                success: function (data) {
                    response($.map(data.features, function (item) {
                        return { label: item.properties.name, value: item.properties.name};
                    }));
                }
            });
        }
    });
</script>