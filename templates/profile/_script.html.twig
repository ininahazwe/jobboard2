<script>
    $("#profile_zipcode").autocomplete({
        source: function (request, response) {
            $.ajax({
                url: "https://api-adresse.data.gouv.fr/search/?postcode="+$("input[name='profile[zipcode]']").val(),
                data: { q: request.term },
                dataType: "json",
                success: function (data) {
                    var postcodes = [];
                    response($.map(data.features, function (item) {

                        if ($.inArray(item.properties.postcode, postcodes) == -1) {
                            postcodes.push(item.properties.postcode);
                            return { label: item.properties.postcode + " - " + item.properties.city,
                                city: item.properties.city,
                                context: item.properties.context,
                                value: item.properties.postcode
                            };
                        }
                    }));
                }
            });
        },
        // On remplit aussi la ville
        select: function(event, ui) {
            $('#profile_city').val(ui.item.city);
            $('#profile_departement').val(ui.item.context);
        }
    });
    $("#profile_city").autocomplete({
        source: function (request, response) {
            $.ajax({
                url: "https://api-adresse.data.gouv.fr/search/?city="+$("input[name='profile[city]']").val(),
                data: { q: request.term },
                dataType: "json",
                success: function (data) {
                    var cities = [];
                    response($.map(data.features, function (item) {
                        // Ici on est obligé d'ajouter les villes dans un array pour ne pas avoir plusieurs fois la même
                        if ($.inArray(item.properties.postcode, cities) == -1) {
                            cities.push(item.properties.postcode);
                            return { label: item.properties.postcode + " - " + item.properties.city,
                                postcode: item.properties.postcode,
                                context: item.properties.context,
                                value: item.properties.city
                            };
                        }
                    }));
                }
            });
        },
        // On remplit aussi le CP
        select: function(event, ui) {
            $('#profile_zipcode').val(ui.item.postcode);
            $('#profile_departement').val(ui.item.context);
        }
    });
</script>